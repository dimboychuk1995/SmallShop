{% extends "layouts/app_base.html" %}
{% block page_title %}Settings ‚Äî Shops{% endblock %}

{% block app_content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h1 class="h4 mb-1">Shops</h1>
    <p class="text-muted mb-0">Manage your shops / branches. Switch active shop and update shop info.</p>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('main.settings') }}">Back to Settings</a>

    <!-- ‚úÖ Add shop toggle -->
    <button class="btn btn-primary btn-sm" type="button"
            data-bs-toggle="collapse" data-bs-target="#addShopCollapse"
            aria-expanded="false" aria-controls="addShopCollapse">
      + Add shop
    </button>
  </div>
</div>

<!-- ‚úÖ Add shop form -->
<div class="collapse mb-3" id="addShopCollapse">
  <div class="card border-primary-subtle">
    <div class="card-header d-flex align-items-center justify-content-between">
      <div class="fw-semibold">Add new shop</div>
      <button class="btn btn-outline-secondary btn-sm" type="button"
              data-bs-toggle="collapse" data-bs-target="#addShopCollapse">
        Close
      </button>
    </div>

    <div class="card-body">
      <form method="POST" action="{{ url_for('settings.locations_index') }}" class="row g-3">
        <div class="col-12 col-md-5">
          <label class="form-label">Shop name <span class="text-danger">*</span></label>
          <input type="text" name="name" class="form-control" placeholder="e.g. LTS Repair Group ‚Äî Chicago" required minlength="2">
          <div class="form-text">This must be unique inside your organization.</div>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Phone</label>
          <input type="text" name="phone" class="form-control" placeholder="+1 (xxx) xxx-xxxx">
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Status</label>
          <input type="text" class="form-control" value="Active" disabled>
          <div class="form-text">New shops are created as active.</div>
        </div>

        <div class="col-12">
          <label class="form-label">Address</label>
          <input type="text" name="address" class="form-control" placeholder="Street, City, State ZIP">
        </div>

        <div class="col-12 d-flex gap-2">
          <button type="submit" class="btn btn-primary">
            Create shop
          </button>
          <button type="button" class="btn btn-outline-secondary"
                  data-bs-toggle="collapse" data-bs-target="#addShopCollapse">
            Cancel
          </button>
        </div>

        <div class="col-12">
          <div class="alert alert-light border mb-0">
            <div class="small text-muted">
              After creation: we automatically grant you access (adds to your <span class="font-monospace">shop_ids</span>)
              and create a separate MongoDB database for this shop.
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="row g-3">
  <!-- Left: list -->
  <div class="col-12 col-lg-8">
    <div class="card">
      <div class="card-header d-flex flex-column flex-md-row gap-2 justify-content-between align-items-md-center">
        <div class="fw-semibold">Shop list</div>

        <div class="d-flex gap-2 align-items-center">
          <div class="input-group input-group-sm" style="max-width: 320px;">
            <span class="input-group-text">Search</span>
            <input class="form-control" type="text" placeholder="Name, city, phone..." disabled>
          </div>
          <button class="btn btn-outline-secondary btn-sm" type="button" disabled>Refresh</button>
        </div>
      </div>

      <div class="card-body p-0">
        {% if shops and shops|length > 0 %}
        <div class="table-responsive">
          <table class="table table-hover mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 34%;">Shop</th>
                <th style="width: 26%;">Contact</th>
                <th style="width: 22%;">Address</th>
                <th style="width: 10%;">Status</th>
                <th class="text-end" style="width: 8%;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for s in shops %}
              <tr>
                <td>
                  <div class="d-flex align-items-center gap-2">
                    <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-light border"
                         style="width: 34px; height: 34px;">
                      <span class="text-muted small">üè¨</span>
                    </div>

                    <div>
                      <div class="fw-semibold">
                        {{ s.name or "‚Äî" }}
                        {% if s.is_primary %}
                          <span class="badge text-bg-secondary ms-1">Primary</span>
                        {% endif %}
                        {% if s.is_active %}
                          <span class="badge text-bg-success ms-1">Active</span>
                        {% else %}
                          <span class="badge text-bg-light text-muted border ms-1">Disabled</span>
                        {% endif %}
                      </div>
                      <div class="text-muted small">
                        {% if s.slug %}<span class="me-2">Slug: <span class="font-monospace">{{ s.slug }}</span></span>{% endif %}
                        {% if s.db_name %}<span>DB: <span class="font-monospace">{{ s.db_name }}</span></span>{% endif %}
                      </div>
                    </div>
                  </div>
                </td>

                <td>
                  <div class="small">
                    <div><span class="text-muted">Phone:</span> {{ s.phone or "‚Äî" }}</div>
                    <div><span class="text-muted">Email:</span> {{ s.email or "‚Äî" }}</div>
                  </div>
                </td>

                <td>
                  <div class="small">
                    <div>{{ s.address_line or s.address or "‚Äî" }}</div>
                    <div class="text-muted">
                      {% if s.city %}{{ s.city }}{% endif %}
                      {% if s.state %}{% if s.city %}, {% endif %}{{ s.state }}{% endif %}
                      {% if s.zip %} {{ s.zip }}{% endif %}
                    </div>
                  </div>
                </td>

                <td>
                  {% if s.status %}
                    <span class="badge text-bg-info">{{ s.status }}</span>
                  {% else %}
                    <span class="badge text-bg-light text-muted border">‚Äî</span>
                  {% endif %}
                </td>

                <td class="text-end">
                  <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-primary" type="button" disabled>Open</button>
                    <button class="btn btn-outline-secondary" type="button" disabled>Edit</button>
                    <button class="btn btn-outline-danger" type="button" disabled>Disable</button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="p-4">
          <div class="text-muted mb-2">No shops yet.</div>
          <div class="small text-muted">
            Your first shop is usually created when the organization is created. Later you‚Äôll be able to add more.
          </div>
          <div class="mt-3">
            <button class="btn btn-primary btn-sm" type="button"
                    data-bs-toggle="collapse" data-bs-target="#addShopCollapse">
              + Add first shop
            </button>
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Future: members/permissions -->
    <div class="card mt-3">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div class="fw-semibold">Shop access</div>
        <button class="btn btn-outline-secondary btn-sm" type="button" disabled>Manage access</button>
      </div>
      <div class="card-body">
        <div class="text-muted small">
          Here we‚Äôll show who has access to which shop (based on user.shop_ids) and allow granting / removing access.
        </div>
      </div>
    </div>
  </div>

  <!-- Right: active shop / quick actions -->
  <div class="col-12 col-lg-4">
    <div class="card">
      <div class="card-header">
        <div class="fw-semibold">Active shop</div>
      </div>
      <div class="card-body">
        <div class="text-muted small mb-2">This is the shop you‚Äôre currently working in.</div>

        <div class="mb-3">
          <label class="form-label">Select active shop</label>
          <select class="form-select form-select-sm" disabled>
            <option selected>Loading‚Ä¶ (API later)</option>
          </select>
          <div class="form-text">Later this will update your session (active shop).</div>
        </div>

        <div class="d-grid gap-2">
          <button class="btn btn-outline-primary btn-sm" type="button" disabled>Switch</button>
          <button class="btn btn-outline-secondary btn-sm" type="button" disabled>View shop profile</button>
        </div>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header">
        <div class="fw-semibold">Notes</div>
      </div>
      <div class="card-body">
        <ul class="small text-muted mb-0">
          <li>Work orders and parts will be stored per shop (shop DB).</li>
          <li>Primary shop is the first shop in the user‚Äôs <span class="font-monospace">shop_ids</span>.</li>
          <li>Active shop will be stored in session (switch anytime).</li>
        </ul>
      </div>
    </div>
  </div>
</div>

{% endblock %}
