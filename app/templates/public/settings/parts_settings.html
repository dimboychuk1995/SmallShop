{% extends "layouts/app_base.html" %}
{% block page_title %}Parts Settings{% endblock %}

{% block app_content %}

<!-- Header (same style as Organization page) -->
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h1 class="h4 mb-1">Parts Settings</h1>
    <p class="text-muted mb-0">Manage parts locations, categories, and pricing rules.</p>

    {% if error_message %}
      <div class="alert alert-warning mt-3 mb-0">{{ error_message }}</div>
    {% endif %}
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('main.settings') }}">Back to Settings</a>
  </div>
</div>

<div class="row g-3">

  <!-- Parts Locations -->
  <div class="col-12 col-xl-6">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h6 mb-0">Parts Locations</h2>
        </div>

        <!-- Create -->
        <form method="post" action="{{ url_for('settings.parts_locations_create') }}" class="row g-2 mb-3">
          <div class="col-12 col-md-8">
            <input type="text" name="name" class="form-control" placeholder="New location name" required>
          </div>
          <div class="col-12 col-md-4">
            <button class="btn btn-primary w-100" type="submit">Add</button>
          </div>
        </form>

        {% if parts_locations and parts_locations|length > 0 %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th style="width: 60%;">Name</th>
                  <th class="text-end" style="width: 40%;">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for loc in parts_locations %}
                  {% set loc_id = loc._id|string %}
                  <tr>
                    <td>
                      {% if edit_location_id == loc_id %}
                        <form method="post" action="{{ url_for('settings.parts_locations_update', location_id=loc_id) }}" class="d-flex gap-2">
                          <input type="text" name="name" class="form-control form-control-sm" value="{{ loc.name }}" required>
                          <button class="btn btn-sm btn-success" type="submit">Save</button>
                          <a class="btn btn-sm btn-outline-secondary"
                             href="{{ url_for('settings.parts_settings_index') }}">Cancel</a>
                        </form>
                      {% else %}
                        {{ loc.name }}
                      {% endif %}
                    </td>
                    <td class="text-end">
                      {% if edit_location_id != loc_id %}
                        <a class="btn btn-sm btn-outline-primary"
                           href="{{ url_for('settings.parts_settings_index', edit_location_id=loc_id) }}">Edit</a>

                        <form method="post"
                              action="{{ url_for('settings.parts_locations_delete', location_id=loc_id) }}"
                              class="d-inline"
                              onsubmit="return confirm('Delete this location?');">
                          <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                        </form>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          {% if pagination_locations and pagination_locations.pages > 1 %}
            <div class="d-flex align-items-center justify-content-between mt-2">
              <div class="small text-muted">
                Page {{ pagination_locations.page }} of {{ pagination_locations.pages }} · {{ pagination_locations.total }} total
              </div>
              <div class="btn-group btn-group-sm" role="group" aria-label="Locations pagination">
                <a class="btn btn-outline-secondary {% if not pagination_locations.has_prev %}disabled{% endif %}"
                   href="{{ url_for('settings.parts_settings_index', loc_page=pagination_locations.prev_page, loc_per_page=pagination_locations.per_page, cat_page=request.args.get('cat_page', 1), cat_per_page=request.args.get('cat_per_page', 20), edit_location_id=edit_location_id, edit_category_id=edit_category_id) }}">Prev</a>
                <a class="btn btn-outline-secondary {% if not pagination_locations.has_next %}disabled{% endif %}"
                   href="{{ url_for('settings.parts_settings_index', loc_page=pagination_locations.next_page, loc_per_page=pagination_locations.per_page, cat_page=request.args.get('cat_page', 1), cat_per_page=request.args.get('cat_per_page', 20), edit_location_id=edit_location_id, edit_category_id=edit_category_id) }}">Next</a>
              </div>
            </div>
          {% endif %}
        {% else %}
          <div class="text-muted">No locations yet.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Parts Categories -->
  <div class="col-12 col-xl-6">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h6 mb-0">Parts Categories</h2>
        </div>

        <!-- Create -->
        <form method="post" action="{{ url_for('settings.parts_categories_create') }}" class="row g-2 mb-3">
          <div class="col-12 col-md-8">
            <input type="text" name="name" class="form-control" placeholder="New category name" required>
          </div>
          <div class="col-12 col-md-4">
            <button class="btn btn-primary w-100" type="submit">Add</button>
          </div>
        </form>

        {% if parts_categories and parts_categories|length > 0 %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th style="width: 60%;">Name</th>
                  <th class="text-end" style="width: 40%;">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for cat in parts_categories %}
                  {% set cat_id = cat._id|string %}
                  <tr>
                    <td>
                      {% if edit_category_id == cat_id %}
                        <form method="post" action="{{ url_for('settings.parts_categories_update', category_id=cat_id) }}" class="d-flex gap-2">
                          <input type="text" name="name" class="form-control form-control-sm" value="{{ cat.name }}" required>
                          <button class="btn btn-sm btn-success" type="submit">Save</button>
                          <a class="btn btn-sm btn-outline-secondary"
                             href="{{ url_for('settings.parts_settings_index') }}">Cancel</a>
                        </form>
                      {% else %}
                        {{ cat.name }}
                      {% endif %}
                    </td>
                    <td class="text-end">
                      {% if edit_category_id != cat_id %}
                        <a class="btn btn-sm btn-outline-primary"
                           href="{{ url_for('settings.parts_settings_index', edit_category_id=cat_id) }}">Edit</a>

                        <form method="post"
                              action="{{ url_for('settings.parts_categories_delete', category_id=cat_id) }}"
                              class="d-inline"
                              onsubmit="return confirm('Delete this category?');">
                          <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                        </form>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          {% if pagination_categories and pagination_categories.pages > 1 %}
            <div class="d-flex align-items-center justify-content-between mt-2">
              <div class="small text-muted">
                Page {{ pagination_categories.page }} of {{ pagination_categories.pages }} · {{ pagination_categories.total }} total
              </div>
              <div class="btn-group btn-group-sm" role="group" aria-label="Categories pagination">
                <a class="btn btn-outline-secondary {% if not pagination_categories.has_prev %}disabled{% endif %}"
                   href="{{ url_for('settings.parts_settings_index', cat_page=pagination_categories.prev_page, cat_per_page=pagination_categories.per_page, loc_page=request.args.get('loc_page', 1), loc_per_page=request.args.get('loc_per_page', 20), edit_location_id=edit_location_id, edit_category_id=edit_category_id) }}">Prev</a>
                <a class="btn btn-outline-secondary {% if not pagination_categories.has_next %}disabled{% endif %}"
                   href="{{ url_for('settings.parts_settings_index', cat_page=pagination_categories.next_page, cat_per_page=pagination_categories.per_page, loc_page=request.args.get('loc_page', 1), loc_per_page=request.args.get('loc_per_page', 20), edit_location_id=edit_location_id, edit_category_id=edit_category_id) }}">Next</a>
              </div>
            </div>
          {% endif %}
        {% else %}
          <div class="text-muted">No categories yet.</div>
        {% endif %}
      </div>
    </div>
  </div>

    <!-- Margin / Markup Rules -->
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div>
            <h2 class="h6 mb-0">Margin / Markup Rules</h2>
            <div class="text-muted small">Define price rules by cost ranges. Add as many ranges as you need.</div>
          </div>

          <div class="btn-group btn-group-sm" role="group" aria-label="Mode">
            <input type="radio" class="btn-check" name="pricing_mode" id="mode_margin" autocomplete="off"
                   {% if pricing_mode != 'markup' %}checked{% endif %}>
            <label class="btn btn-outline-primary" for="mode_margin">Margin</label>

            <input type="radio" class="btn-check" name="pricing_mode" id="mode_markup" autocomplete="off"
                   {% if pricing_mode == 'markup' %}checked{% endif %}>
            <label class="btn btn-outline-primary" for="mode_markup">Markup</label>
          </div>
        </div>

        <div class="alert alert-info py-2 mb-3">
          <div class="small mb-0">
            <strong>Tip:</strong> Leave <em>To</em> empty to represent <strong>∞</strong>. Values are percentages (e.g. 60 = 60%).
          </div>
        </div>

        <form onsubmit="return false;">
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-2" id="mmRulesTable">
              <thead>
                <tr>
                  <th style="width: 25%;">From</th>
                  <th style="width: 25%;">To</th>
                  <th style="width: 25%;"><span id="mmValueLabel">{% if pricing_mode == 'markup' %}Markup %{% else %}Margin %{% endif %}</span></th>
                  <th class="text-end" style="width: 25%;">Actions</th>
                </tr>
              </thead>

              <tbody id="mmRulesBody">
                {% if pricing_rules and pricing_rules|length > 0 %}
                  {% for r in pricing_rules %}
                    <tr>
                      <td>
                        <input type="number" step="0.01" min="0" class="form-control form-control-sm mm-from"
                               value="{{ r.from if r.from is not none else '' }}">
                      </td>
                      <td>
                        <input type="number" step="0.01" min="0" class="form-control form-control-sm mm-to"
                               value="{{ r.to if r.to is not none else '' }}">
                      </td>
                      <td>
                        <div class="input-group input-group-sm">
                          <input type="number" step="0.01" class="form-control mm-val"
                                 value="{{ r.value_percent if r.value_percent is not none else '' }}">
                          <span class="input-group-text">%</span>
                        </div>
                      </td>
                      <td class="text-end">
                        <button class="btn btn-sm btn-outline-danger mm-del" type="button" title="Remove">
                          <i class="bi bi-trash"></i> Remove
                        </button>
                      </td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <!-- fallback if DB doc missing -->
                  <tr>
                    <td><input type="number" step="0.01" min="0" class="form-control form-control-sm mm-from" value="0"></td>
                    <td><input type="number" step="0.01" min="0" class="form-control form-control-sm mm-to" value="20"></td>
                    <td>
                      <div class="input-group input-group-sm">
                        <input type="number" step="0.01" class="form-control mm-val" value="100">
                        <span class="input-group-text">%</span>
                      </div>
                    </td>
                    <td class="text-end">
                      <button class="btn btn-sm btn-outline-danger mm-del" type="button" title="Remove">
                        <i class="bi bi-trash"></i> Remove
                      </button>
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>

          <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary" type="button" id="mmAddRow">
                <i class="bi bi-plus-lg"></i> Add range
              </button>

              <button class="btn btn-sm btn-outline-secondary" type="button" id="mmNormalize">
                <i class="bi bi-magic"></i> Auto-fill next "From"
              </button>
            </div>

            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-primary" type="button" id="mmSaveRules">
                <i class="bi bi-save"></i> Save
              </button>

              <button class="btn btn-sm btn-outline-secondary" type="button" id="mmDumpJson">
                <i class="bi bi-braces"></i> Preview JSON
              </button>
            </div>
          </div>

          <div id="mmJsonPreviewWrap" class="mt-3 d-none">
            <div class="text-muted small mb-1">Preview:</div>
            <pre class="bg-light border rounded p-2 mb-0" style="max-height:240px; overflow:auto;"><code id="mmJsonPreview"></code></pre>
          </div>
        </form>
      </div>
    </div>
  </div>


</div>

<!-- Move JS to external file -->
<script src="{{ url_for('static', filename='js/settings/parts_settings.js') }}"></script>

{% endblock %}
