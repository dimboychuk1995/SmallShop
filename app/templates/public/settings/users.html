{% extends "layouts/app_base.html" %}
{% block page_title %}Settings — Users{% endblock %}

{% block app_content %}
<!-- template: public/settings/users.html -->

<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h1 class="h4 mb-1">Users</h1>
    <p class="text-muted mb-0">Create and manage users for your organization.</p>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('main.settings') }}">Back to Settings</a>
    <button class="btn btn-primary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#createUserModal">
      + New user
    </button>
  </div>
</div>

<!-- Quick info -->
<div class="alert alert-light border mb-3">
  <div class="d-flex flex-column flex-md-row gap-2 justify-content-between">
    <div>
      <div class="fw-semibold">Tip</div>
      <div class="text-muted small">Now you can choose which shops the user can access.</div>
    </div>
    <div class="text-muted small">
      Required permission: <span class="badge text-bg-secondary">settings.manage_users</span>
    </div>
  </div>
</div>

<!-- Users list -->
<div class="card">
  <div class="card-header d-flex flex-column flex-md-row gap-2 justify-content-between align-items-md-center">
    <div class="fw-semibold">Users</div>

    <div class="d-flex gap-2">
      <input class="form-control form-control-sm" type="text" placeholder="Search (later)" disabled>
      <button class="btn btn-outline-secondary btn-sm" type="button" disabled>Search</button>
    </div>
  </div>

  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th class="ps-3">Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Status</th>
            <th class="text-end pe-3">Actions</th>
          </tr>
        </thead>
        <tbody>

          {% if users %}
            {% for u in users %}
              <tr>
                <td class="ps-3">
                  <div class="fw-semibold">
                    {{ u.get("name") or (u.get("first_name","") ~ " " ~ u.get("last_name","")) or "—" }}
                  </div>
                  <div class="text-muted small">
                    ID: {{ u.get("_id") or "—" }}
                  </div>
                </td>
                <td>{{ u.get("email") or "—" }}</td>
                <td>
                  <span class="badge text-bg-secondary">{{ u.get("role") or "viewer" }}</span>
                </td>
                <td>
                  {% if u.get("is_active", True) %}
                    <span class="badge text-bg-success">Active</span>
                  {% else %}
                    <span class="badge text-bg-danger">Inactive</span>
                  {% endif %}
                </td>
                <td class="text-end pe-3">
                  <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-secondary" type="button" disabled>Edit</button>
                    <button class="btn btn-outline-danger" type="button" disabled>Deactivate</button>
                  </div>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="5" class="p-4">
                <div class="text-center">
                  <div class="fw-semibold mb-1">No users yet</div>
                  <div class="text-muted mb-3">Create your first team member.</div>
                  <button class="btn btn-primary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#createUserModal">
                    + New user
                  </button>
                </div>
              </td>
            </tr>
          {% endif %}

        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h2 class="modal-title h5" id="createUserModalLabel">Create new user</h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form method="post" action="{{ url_for('settings.users_index') }}">
        <div class="modal-body">

          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label" for="first_name">First name</label>
              <input class="form-control" id="first_name" name="first_name" type="text" required>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="last_name">Last name</label>
              <input class="form-control" id="last_name" name="last_name" type="text" required>
            </div>

            <div class="col-12">
              <label class="form-label" for="email">Email</label>
              <input class="form-control" id="email" name="email" type="email" placeholder="user@company.com" required>
              <div class="form-text">We’ll later add “Send invite email” flow.</div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="phone">Phone (optional)</label>
              <input class="form-control" id="phone" name="phone" type="tel" placeholder="+1 (555) 555-5555">
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="role">Role</label>
              <select class="form-select" id="role" name="role" required>
                <option value="manager">Manager</option>
                <option value="parts_manager">Parts manager</option>
                <option value="senior_mechanic">Senior mechanic</option>
                <option value="mechanic">Mechanic</option>
                <option value="viewer">Viewer</option>
                <option value="general_manager">General manager</option>
              </select>
              <div class="form-text">Later we will load roles from tenant DB dynamically.</div>
            </div>

            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="1" id="is_active" name="is_active" checked>
                <label class="form-check-label" for="is_active">
                  Active user
                </label>
              </div>
            </div>

            <hr class="my-2">

            <!-- ✅ Shop access чекбоксы -->
            <div class="col-12">
              <label class="form-label mb-1">Shop access</label>
              <div class="text-muted small mb-2">
                Select shops this user can work with. The first selected shop will be treated as primary later.
              </div>

              {% if shops_for_form and shops_for_form|length > 0 %}
                <div class="row g-2">
                  {% for s in shops_for_form %}
                    <div class="col-12 col-md-6">
                      <div class="form-check border rounded p-2">
                        <input class="form-check-input"
                               type="checkbox"
                               name="shop_ids"
                               id="shop_{{ s.id }}"
                               value="{{ s.id }}"
                               {% if active_shop_id and active_shop_id == s.id %}checked{% endif %}>
                        <label class="form-check-label" for="shop_{{ s.id }}">
                          {{ s.name }}
                        </label>
                      </div>
                    </div>
                  {% endfor %}
                </div>
                <div class="form-text mt-2">
                  Tip: we pre-selected your current active shop.
                </div>
              {% else %}
                <div class="alert alert-warning border mb-0">
                  No shops found. Create a shop first in Settings → Shops.
                </div>
              {% endif %}
            </div>

            <hr class="my-2">

            <div class="col-12 col-md-6">
              <label class="form-label" for="password">Password</label>
              <input class="form-control" id="password" name="password" type="password" required minlength="8">
              <div class="form-text">Minimum 8 characters.</div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="password_confirm">Confirm password</label>
              <input class="form-control" id="password_confirm" name="password_confirm" type="password" required minlength="8">
            </div>

          </div>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create user</button>
        </div>
      </form>

    </div>
  </div>
</div>

{% endblock %}
