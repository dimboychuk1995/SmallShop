{% extends "layouts/app_base.html" %}

{% block page_title %}Vendors{% endblock %}

{% block app_content %}
<div class="card">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div>
        <h1 class="h4 mb-1">Vendors</h1>
        <p class="text-muted mb-0">Manage your vendors list for the active shop.</p>
      </div>

      {% if "vendors.edit" in user_permissions %}
      <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#createVendorForm">
        + New Vendor
      </button>
      {% endif %}
    </div>

    {% if "vendors.edit" in user_permissions %}
    <div class="collapse mt-3" id="createVendorForm">
      <form method="POST" action="{{ url_for('vendors.vendors_create') }}" class="border rounded p-3 bg-light">
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label mb-1">Name *</label>
            <input type="text" name="name" class="form-control" required />
          </div>
          <div class="col-md-4">
            <label class="form-label mb-1">Phone</label>
            <input type="text" name="phone" class="form-control" />
          </div>
          <div class="col-md-4">
            <label class="form-label mb-1">Email</label>
            <input type="email" name="email" class="form-control" />
          </div>

          <div class="col-md-4">
            <label class="form-label mb-1">Website</label>
            <input type="text" name="website" class="form-control" placeholder="https://..." />
          </div>
          <div class="col-md-4">
            <label class="form-label mb-1">Primary contact (First name)</label>
            <input type="text" name="primary_contact_first_name" class="form-control" />
          </div>
          <div class="col-md-4">
            <label class="form-label mb-1">Primary contact (Last name)</label>
            <input type="text" name="primary_contact_last_name" class="form-control" />
          </div>

          <div class="col-md-8">
            <label class="form-label mb-1">Address</label>
            <input type="text" name="address" class="form-control" />
          </div>
          <div class="col-md-4">
            <label class="form-label mb-1">Notes</label>
            <input type="text" name="notes" class="form-control" />
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button type="submit" class="btn btn-success">Create</button>
          <button type="button" class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#createVendorForm">
            Cancel
          </button>
        </div>
      </form>
    </div>
    {% endif %}

    <hr class="my-3" />

    {% if vendors and vendors|length > 0 %}
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr class="text-muted">
              <th style="width: 18%;">Name</th>
              <th style="width: 12%;">Phone</th>
              <th style="width: 16%;">Email</th>
              <th style="width: 14%;">Website</th>
              <th style="width: 14%;">Primary contact</th>
              <th style="width: 16%;">Address</th>
              <th style="width: 6%;" class="text-end">Status</th>
              <th style="width: 4%;" class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for v in vendors %}
            <tr>
              <td class="fw-semibold">{{ v.get('name', '—') }}</td>
              <td>{{ v.get('phone') or '—' }}</td>
              <td>{{ v.get('email') or '—' }}</td>

              <td>
                {% set site = v.get('website') %}
                {% if site %}
                  <a href="{{ site }}" target="_blank" rel="noopener noreferrer">{{ site }}</a>
                {% else %}
                  —
                {% endif %}
              </td>

              <td>
                {% set fn = v.get('primary_contact_first_name') or '' %}
                {% set ln = v.get('primary_contact_last_name') or '' %}
                {% set full = (fn ~ ' ' ~ ln).strip() %}
                {{ full if full else '—' }}
              </td>

              <td>{{ v.get('address') or '—' }}</td>

              <td class="text-end">
                {% if v.get('is_active', True) %}
                  <span class="badge bg-success">Active</span>
                {% else %}
                  <span class="badge bg-secondary">Inactive</span>
                {% endif %}
              </td>

              <td class="text-end">
                <div class="d-inline-flex gap-1">
                  {% if "vendors.edit" in user_permissions %}
                    <button type="button" class="btn btn-sm btn-outline-primary" disabled title="Edit will be added later">
                      Edit
                    </button>
                  {% endif %}

                  {% if "vendors.deactivate" in user_permissions %}
                    {% if v.get('is_active', True) %}
                      <form method="POST" action="{{ url_for('vendors.vendors_deactivate', vendor_id=v['_id']) }}" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                          Delete
                        </button>
                      </form>
                    {% else %}
                      <form method="POST" action="{{ url_for('vendors.vendors_restore', vendor_id=v['_id']) }}" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-outline-success">
                          Restore
                        </button>
                      </form>
                    {% endif %}
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <p class="text-muted small mt-2 mb-0">
        Showing {{ vendors|length }} vendor{{ 's' if vendors|length != 1 else '' }}.
      </p>
    {% else %}
      <p class="text-muted mb-0">No vendors yet.</p>
    {% endif %}
  </div>
</div>
{% endblock %}
