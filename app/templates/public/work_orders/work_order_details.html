{% extends "layouts/app_base.html" %}
{% block page_title %}Work Order Details{% endblock %}

{% block app_content %}
<div class="card">
  <div class="card-body">

    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h4 mb-0">Create Work Order</h1>
      <a class="btn btn-outline-secondary" href="{{ url_for('work_orders.work_orders_page') }}">Back</a>
    </div>

    <!-- Customer (auto-submit) -->
    <form method="get" action="{{ url_for('work_orders.work_order_details_page') }}" class="mb-3">
      <label class="form-label">Customer</label>
      <select name="customer_id" class="form-select" required onchange="this.form.submit()">
        <option value="">-- Select customer --</option>
        {% for c in customers %}
          <option value="{{ c.id }}" {% if c.id == selected_customer_id %}selected{% endif %}>
            {{ c.label }}
          </option>
        {% endfor %}
      </select>
    </form>

    {% if selected_customer_id %}

      <!-- Unit (auto-submit) -->
      <form method="get" action="{{ url_for('work_orders.work_order_details_page') }}" class="mb-4">
        <input type="hidden" name="customer_id" value="{{ selected_customer_id }}"/>

        <div class="row g-3 align-items-end">
          <div class="col-md-8">
            <label class="form-label">Unit</label>
            <select name="unit_id" class="form-select" onchange="this.form.submit()">
              <option value="">-- Select unit --</option>
              {% for u in units %}
                <option value="{{ u.id }}" {% if u.id == selected_unit_id %}selected{% endif %}>
                  {{ u.label }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4">
            <button type="button" class="btn btn-success w-100"
                    data-bs-toggle="modal" data-bs-target="#createUnitModal">
              + Add Unit
            </button>
          </div>
        </div>
      </form>

      <!-- Create Unit modal -->
      <div class="modal fade" id="createUnitModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <form method="post" action="{{ url_for('work_orders.create_unit') }}">
              <input type="hidden" name="customer_id" value="{{ selected_customer_id }}"/>

              <div class="modal-header">
                <h5 class="modal-title">Create New Unit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>

              <div class="modal-body">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">VIN number</label>
                    <input name="vin" class="form-control" maxlength="32"/>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Unit Number</label>
                    <input name="unit_number" class="form-control" maxlength="32"/>
                  </div>

                  <div class="col-md-3">
                    <label class="form-label">Make</label>
                    <input name="make" class="form-control" maxlength="64"/>
                  </div>

                  <div class="col-md-3">
                    <label class="form-label">Model</label>
                    <input name="model" class="form-control" maxlength="64"/>
                  </div>

                  <div class="col-md-2">
                    <label class="form-label">Year</label>
                    <input name="year" class="form-control" inputmode="numeric"/>
                  </div>

                  <div class="col-md-2">
                    <label class="form-label">Type</label>
                    <input name="type" class="form-control" maxlength="64"/>
                  </div>

                  <div class="col-md-2">
                    <label class="form-label">Mileage</label>
                    <input name="mileage" class="form-control" inputmode="numeric"/>
                  </div>
                </div>
              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-success">Create Unit</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      {% if selected_unit_id %}

        <!-- Data for JS -->
        <script type="application/json" id="laborRatesData">{{ labor_rates|tojson }}</script>
        <script type="application/json" id="partsPricingRulesData">{{ parts_pricing_rules|tojson }}</script>

        <!-- Work order lines -->
        <form method="post" action="{{ url_for('work_orders.preview_work_order') }}" class="mt-3">
          <input type="hidden" name="customer_id" value="{{ selected_customer_id }}"/>
          <input type="hidden" name="unit_id" value="{{ selected_unit_id }}"/>

          <div class="d-flex flex-wrap gap-3 align-items-center mb-3 text-muted small">
            <div>Labor total: <strong id="laborTotalDisplay">—</strong></div>
            <div>Parts total: <strong id="partsTotalDisplay">—</strong></div>
            <div>Grand total: <strong id="grandTotalDisplay">—</strong></div>
          </div>

          <div class="card border mb-3">
            <div class="card-body">
              <h2 class="h6 mb-3">Labor</h2>

              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Labor Description</label>
                  <input name="labor_description" class="form-control" maxlength="200" value="{{ labor_description }}">
                </div>

                <div class="col-md-2">
                  <label class="form-label">Hours</label>
                  <input id="labor_hours" name="labor_hours" class="form-control" inputmode="decimal" value="{{ labor_hours }}">
                </div>

                <div class="col-md-4">
                  <label class="form-label">Labor Rate</label>
                  <select id="labor_rate_code" name="labor_rate_code" class="form-select">
                    <option value="">-- Select rate --</option>
                    {% for r in labor_rates %}
                      <option value="{{ r.code }}" {% if r.code == labor_rate_code %}selected{% endif %}>
                        {{ r.name }} (${{ "%.2f"|format(r.hourly_rate) }}/hr)
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </div>

            </div>
          </div>

          <div class="card border">
            <div class="card-body">
              <h2 class="h6 mb-3">Parts</h2>

              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead class="table-light">
                    <tr>
                      <th style="width:18%;">Part Number</th>
                      <th>Description</th>
                      <th style="width:10%;">Count</th>
                      <th style="width:14%;">Cost</th>
                      <th style="width:14%;">Price</th>
                      <th style="width:14%;">Line Total</th>
                    </tr>
                  </thead>
                  <tbody id="partsTbody">
                    {# JS will create rows here #}
                  </tbody>
                </table>
              </div>

              <div class="mt-3 d-flex justify-content-end gap-2">
                <button class="btn btn-outline-secondary" type="submit" name="action" value="recalc">
                  Save Draft
                </button>
                <button class="btn btn-primary" type="submit" name="action" value="create">
                  Create Work Order
                </button>
              </div>

            </div>
          </div>
        </form>

        <script src="{{ url_for('static', filename='js/work_order_details.js') }}"></script>

      {% else %}
        <div class="alert alert-info mb-0">Select a unit (or create one) to continue.</div>
      {% endif %}

    {% else %}
      <div class="alert alert-info mb-0">Select a customer to continue.</div>
    {% endif %}

  </div>
</div>
{% endblock %}
