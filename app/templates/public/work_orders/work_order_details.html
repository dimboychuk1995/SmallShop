{% extends "layouts/app_base.html" %}
{% block page_title %}Work Order Details{% endblock %}

{% block app_content %}
<div class="card">
  <div class="card-body">

    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h4 mb-0">Create Work Order</h1>
      <a class="btn btn-outline-secondary" href="{{ url_for('work_orders.work_orders_page') }}">Back</a>
    </div>

    <!-- Customer select (NO reload) -->
    <div class="mb-3">
      <label class="form-label">Customer</label>
      <select id="customerSelect" name="customer_id" class="form-select" required>
        <option value="">-- Select customer --</option>
        {% for c in customers %}
          <option value="{{ c.id }}" {% if c.id == selected_customer_id %}selected{% endif %}>
            {{ c.label }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Unit select (NO reload) -->
    <div class="mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-md-8">
          <label class="form-label">Unit</label>
          <select id="unitSelect" name="unit_id" class="form-select" {% if not selected_customer_id %}disabled{% endif %}>
            <option value="">-- Select unit --</option>
            {% for u in units %}
              <option value="{{ u.id }}" {% if u.id == selected_unit_id %}selected{% endif %}>
                {{ u.label }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4">
          <button id="addUnitBtn" type="button" class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#createUnitModal"
                  {% if not selected_customer_id %}disabled{% endif %}>
            + Add Unit
          </button>
        </div>
      </div>
    </div>

    <!-- Create unit modal -->
    <div class="modal fade" id="createUnitModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <form method="post" action="{{ url_for('work_orders.create_unit') }}">
            <input type="hidden" id="createUnitCustomerHidden" name="customer_id" value="{{ selected_customer_id or '' }}"/>

            <div class="modal-header">
              <h5 class="modal-title">Create New Unit</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">VIN number</label>
                  <div class="position-relative">
                    <input id="unitVinInput" name="vin" class="form-control" maxlength="32" placeholder="Enter 17-character VIN"/>
                    <div id="vinLoadingSpinner" class="position-absolute top-50 end-0 translate-middle-y me-2" style="display: none;">
                      <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </div>
                  </div>
                  <small class="form-text text-muted">VIN will auto-fill Make, Model, Year, and Type</small>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Unit Number</label>
                  <input name="unit_number" class="form-control" maxlength="32"/>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Make</label>
                  <input id="unitMakeInput" name="make" class="form-control" maxlength="64"/>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Model</label>
                  <input id="unitModelInput" name="model" class="form-control" maxlength="64"/>
                </div>

                <div class="col-md-2">
                  <label class="form-label">Year</label>
                  <input id="unitYearInput" name="year" class="form-control" inputmode="numeric"/>
                </div>

                <div class="col-md-2">
                  <label class="form-label">Type</label>
                  <input id="unitTypeInput" name="type" class="form-control" maxlength="64"/>
                </div>

                <div class="col-md-2">
                  <label class="form-label">Mileage</label>
                  <input name="mileage" class="form-control" inputmode="numeric"/>
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-success">Create Unit</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Data for JS -->
    <script type="application/json" id="customersData">{{ customers|tojson }}</script>
    <script type="application/json" id="laborRatesData">{{ labor_rates|tojson }}</script>
    <script type="application/json" id="partsPricingRulesData">{{ parts_pricing_rules|tojson }}</script>
    <script type="application/json" id="shopSupplyData">{{ {"percentage": shop_supply_procentage}|tojson }}</script>
    <script type="application/json" id="workOrderDraftData">{{ (draft_labors or draft_blocks or [])|tojson }}</script>
    <script type="application/json" id="workOrderTotalsData">{{ (draft_totals or {})|tojson }}</script>
    <script type="application/json" id="workOrderCreatedData">{{ {"created": work_order_created, "id": created_work_order_id, "status": work_order_status}|tojson }}</script>



    <!-- Work Order editor -->
    <form id="workOrderForm" method="post" action="{{ url_for('work_orders.preview_work_order') }}" class="mt-3">


      <!-- hidden ids that JS updates (important) -->
      <input type="hidden" id="selectedCustomerHidden" name="customer_id" value="{{ selected_customer_id or '' }}"/>
      <input type="hidden" id="selectedUnitHidden" name="unit_id" value="{{ selected_unit_id or '' }}"/>
      <input type="hidden" name="action" id="actionHidden" value="recalc">

      <!-- info -->
      <div id="selectHint" class="alert alert-info mb-3" {% if selected_unit_id %}style="display:none;"{% endif %}>
        Select a customer and unit to continue. Your draft labors will stay on the page when you switch customer/unit.
      </div>

      <fieldset id="workOrderEditor" {% if not selected_unit_id %}disabled{% endif %}>

        <div class="d-flex flex-wrap gap-3 align-items-center mb-3 text-muted small">
          <div>Labor total: <strong id="laborGrandTotalDisplay">—</strong></div>
          <div>Parts total: <strong id="partsGrandTotalDisplay">—</strong></div>
          <div id="coreGrandTotalWrap" style="display:none;">Core total: <strong id="coreGrandTotalDisplay">—</strong></div>
          <div id="miscGrandTotalWrap" style="display:none;">Misc total: <strong id="miscGrandTotalDisplay">—</strong></div>
          <div id="shopSupplyGrandTotalWrap" style="display:none;">Shop supply: <strong id="shopSupplyGrandTotalDisplay">—</strong></div>
          <div>Grand total: <strong id="grandTotalDisplay">—</strong></div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="text-muted small">Labors: <strong id="laborCount">1</strong></div>
          <button type="button" class="btn btn-outline-primary btn-sm" id="addLaborBtn">+ Add Labor</button>
        </div>

        <div id="laborsContainer">

          <!-- Block template instance #0 -->
          <div class="card border mb-3 wo-labor" data-labor-index="0">
            <div class="card-body">

              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h2 class="h6 mb-0">Labor <span class="labor-number">1</span></h2>
                  <div class="text-muted small mt-1">
                    Labor: <strong class="laborTotalDisplay">—</strong>
                    &nbsp;|&nbsp;
                    Parts: <strong class="partsTotalDisplay">—</strong>
                    <span class="coreTotalWrap" style="display:none;">
                      &nbsp;|&nbsp;
                      Core: <strong class="coreTotalDisplay">—</strong>
                    </span>
                    <span class="miscTotalWrap" style="display:none;">
                      &nbsp;|&nbsp;
                      Misc: <strong class="miscTotalDisplay">—</strong>
                    </span>
                    <span class="shopSupplyTotalWrap" style="display:none;">
                      &nbsp;|&nbsp;
                      Shop supply: <strong class="shopSupplyTotalDisplay">—</strong>
                    </span>
                    &nbsp;|&nbsp;
                    Labor total: <strong class="laborFullTotalDisplay">—</strong>
                  </div>
                </div>

                <button type="button" class="btn btn-outline-danger btn-sm removeLaborBtn" disabled>
                  Remove
                </button>
              </div>

              <hr class="my-3"/>

              <div class="row g-3">
                <div class="col-md-5">
                  <label class="form-label">Labor Description</label>
                  <input class="form-control labor-description" name="labors[0][labor_description]" maxlength="200">
                </div>

                <div class="col-md-2">
                  <label class="form-label">Hours</label>
                  <input class="form-control labor-hours" name="labors[0][labor_hours]" inputmode="decimal">
                </div>

                <div class="col-md-3">
                  <label class="form-label">Labor Rate</label>
                  <select class="form-select labor-rate" name="labors[0][labor_rate_code]">
                    <option value="">-- Select rate --</option>
                    {% for r in labor_rates %}
                      <option value="{{ r.code }}">{{ r.name }} (${{ "%.2f"|format(r.hourly_rate) }}/hr)</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="col-md-2">
                  <label class="form-label">Labor Total</label>
                  <input class="form-control labor-total-input" name="labors[0][labor_total_ui]" inputmode="decimal">
                </div>
              </div>

              <div class="mt-3">
                <h3 class="h6 mb-2">Parts</h3>

                <div class="table-responsive">
                  <table class="table table-sm align-middle">
                    <thead class="table-light">
                      <tr>
                        <th style="width:18%;">Part Number</th>
                        <th>Description</th>
                        <th style="width:10%;">Count</th>
                        <th style="width:14%;">Cost</th>
                        <th style="width:14%;">Price</th>
                        <th style="width:14%;">Line Total</th>
                      </tr>
                    </thead>

                    <tbody class="partsTbody">
                      <tr class="parts-row" data-index="0">
                        <td>
                          <input class="form-control form-control-sm part-number" name="labors[0][parts][0][part_number]" maxlength="64" autocomplete="off">
                          <input type="hidden" class="part-core-charge" name="labors[0][parts][0][core_charge]" value="0">
                          <input type="hidden" class="part-misc-charge" name="labors[0][parts][0][misc_charge]" value="0">
                          <input type="hidden" class="part-misc-charge-description" name="labors[0][parts][0][misc_charge_description]" value="">
                        </td>
                        <td><input class="form-control form-control-sm part-description" name="labors[0][parts][0][description]" maxlength="200" autocomplete="off"></td>
                        <td><input class="form-control form-control-sm part-qty" name="labors[0][parts][0][qty]" inputmode="numeric"></td>
                        <td>
                          <input class="form-control form-control-sm part-cost" name="labors[0][parts][0][cost]" inputmode="decimal" readonly tabindex="-1">
                          <div class="small text-muted mt-1 part-charges-meta"></div>
                        </td>
                        <td><input class="form-control form-control-sm part-price" name="labors[0][parts][0][price]" value="" inputmode="decimal"></td>
                        <td class="part-line-total"><span class="text-muted">—</span></td>
                      </tr>
                    </tbody>

                  </table>
                  <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-outline-info" id="addMiscChargePartBtn">
                      + Add Misc Charge
                    </button>
                  </div>
                </div>

                <div class="mt-3 miscChargesEditWrap" style="display:none;">
                  <h4 class="h6 mb-2">Misc Charges</h4>
                  <div class="table-responsive">
                    <table class="table table-sm align-middle miscChargesTable">
                      <thead class="table-light">
                        <tr>
                          <th>Description</th>
                          <th style="width:15%;">Quantity</th>
                          <th style="width:15%;">Price</th>
                          <th style="width:15%;">Total</th>
                          <th style="width:10%;"></th>
                        </tr>
                      </thead>
                      <tbody class="miscChargesTbody">
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

            </div>
          </div>

        </div>

      </fieldset>

       <div class="mt-3 d-flex justify-content-end gap-2">
          <button id="editWorkOrderBtn" class="btn btn-outline-primary" type="button" style="display:none;">Edit</button>
          <button id="saveWorkOrderBtn" class="btn btn-primary" type="button" style="display:none;">Save</button>

          <button id="paidWorkOrderBtn" class="btn btn-success" type="button" style="display:none;">Paid</button>
          <button id="unpaidWorkOrderBtn" class="btn btn-warning" type="button" style="display:none;">Unpaid</button>

          <button id="createWorkOrderBtn" class="btn btn-primary" type="button">Create Work Order</button>
        </div>

    </form>

    <!-- Add Misc Charge Modal -->
    <div class="modal fade" id="addMiscChargeModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Misc Charge</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Description</label>
              <input type="text" id="miscChargeDescInput" class="form-control" maxlength="100" placeholder="e.g., Disposal fee, Labor charge, etc.">
            </div>

            <div class="mb-3">
              <label class="form-label">Quantity</label>
              <input type="number" id="miscChargeQtyInput" class="form-control" inputmode="numeric" placeholder="1" step="1" value="1">
            </div>

            <div class="mb-3">
              <label class="form-label">Price (per unit)</label>
              <input type="number" id="miscChargePriceInput" class="form-control" inputmode="decimal" placeholder="0.00" step="0.01">
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="miscChargeAddBtn" class="btn btn-primary">Add Charge</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Record Payment</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <div class="alert alert-info mb-3">
              <div class="small">Invoice Total: <strong id="paymentInvoiceTotal">—</strong></div>
              <div class="small">Already Paid: <strong id="paymentAlreadyPaid">—</strong></div>
              <div class="small">Remaining Balance: <strong id="paymentRemainingBalance">—</strong></div>
            </div>

            <div class="mb-3">
              <label class="form-label">Payment Amount</label>
              <input type="number" id="paymentAmountInput" class="form-control" inputmode="decimal" placeholder="0.00" step="0.01" min="0">
              <small class="text-muted" id="paymentAmountHelp"></small>
            </div>

            <div class="mb-3">
              <label class="form-label">Payment Method</label>
              <select id="paymentMethodInput" class="form-select">
                <option value="cash">Cash</option>
                <option value="check">Check</option>
                <option value="credit_card">Credit Card</option>
                <option value="ach">ACH</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Notes (optional)</label>
              <textarea id="paymentNotesInput" class="form-control" rows="2" placeholder="e.g., Check #12345, etc."></textarea>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="paymentSubmitBtn" class="btn btn-primary">Record Payment</button>
          </div>
        </div>
      </div>
    </div>

    <script src="{{ url_for('static', filename='js/work_orders/work_order_details.js') }}"></script>

  </div>
</div>
{% endblock %}
