{% extends "layouts/app_base.html" %}
{% block page_title %}Work Order Details{% endblock %}

{% block app_content %}
<div class="card">
  <div class="card-body">

    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h4 mb-0">Create Work Order</h1>
      <a class="btn btn-outline-secondary" href="{{ url_for('work_orders.work_orders_page') }}">Back</a>
    </div>

    <!-- 1) Select Customer -->
    <form method="get" action="{{ url_for('work_orders.work_order_details_page') }}" class="mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-md-8">
          <label class="form-label">Customer</label>
          <select name="customer_id" class="form-select" required>
            <option value="">-- Select customer --</option>
            {% for c in customers %}
              <option value="{{ c.id }}" {% if c.id == selected_customer_id %}selected{% endif %}>
                {{ c.label }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4">
          <button class="btn btn-primary w-100" type="submit">Choose</button>
        </div>
      </div>
    </form>

    {% if selected_customer_id %}

      <!-- 2) Select existing Unit (auto-submit on change) -->
      <form method="get" action="{{ url_for('work_orders.work_order_details_page') }}" class="mb-3">
        <input type="hidden" name="customer_id" value="{{ selected_customer_id }}"/>

        <div class="row g-3 align-items-end">
          <div class="col-md-8">
            <label class="form-label">Unit</label>
            <select name="unit_id" class="form-select" onchange="this.form.submit()">
              <option value="">-- Select unit --</option>
              {% for u in units %}
                <option value="{{ u.id }}" {% if u.id == selected_unit_id %}selected{% endif %}>
                  {{ u.label }}
                </option>
              {% endfor %}
            </select>
            <div class="form-text">
              You can select an existing unit or create a new one.
            </div>
          </div>

          <div class="col-md-4 d-flex justify-content-end">
            <button type="button" class="btn btn-success w-100"
                    data-bs-toggle="modal" data-bs-target="#createUnitModal">
              + Add Unit
            </button>
          </div>
        </div>
      </form>

      <!-- 3) Create Unit (modal) -->
      <div class="modal fade" id="createUnitModal" tabindex="-1" aria-labelledby="createUnitModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <form method="post" action="{{ url_for('work_orders.create_unit') }}">
              <input type="hidden" name="customer_id" value="{{ selected_customer_id }}"/>

              <div class="modal-header">
                <h5 class="modal-title" id="createUnitModalLabel">Create New Unit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>

              <div class="modal-body">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">VIN number</label>
                    <input name="vin" class="form-control" maxlength="32"/>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Unit Number</label>
                    <input name="unit_number" class="form-control" maxlength="32"/>
                  </div>

                  <div class="col-md-3">
                    <label class="form-label">Make</label>
                    <input name="make" class="form-control" maxlength="64"/>
                  </div>

                  <div class="col-md-3">
                    <label class="form-label">Model</label>
                    <input name="model" class="form-control" maxlength="64"/>
                  </div>

                  <div class="col-md-2">
                    <label class="form-label">Year</label>
                    <input name="year" class="form-control" inputmode="numeric"/>
                  </div>

                  <div class="col-md-2">
                    <label class="form-label">Type</label>
                    <input name="type" class="form-control" maxlength="64"/>
                  </div>

                  <div class="col-md-2">
                    <label class="form-label">Mileage</label>
                    <input name="mileage" class="form-control" inputmode="numeric"/>
                  </div>
                </div>
              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-success">Create Unit</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- 4) Create Work Order -->
      <form method="post" action="{{ url_for('work_orders.create_work_order') }}">
        <input type="hidden" name="customer_id" value="{{ selected_customer_id }}"/>
        <input type="hidden" name="unit_id" value="{{ selected_unit_id }}"/>

        <div class="d-flex justify-content-end">
          <button class="btn btn-primary" type="submit" {% if not selected_unit_id %}disabled{% endif %}>
            Create Work Order
          </button>
        </div>

        {% if not selected_unit_id %}
          <div class="form-text mt-2">
            Select a unit (or create one) to enable work order creation.
          </div>
        {% endif %}
      </form>

    {% else %}
      <div class="alert alert-info mb-0">
        Select a customer to continue.
      </div>
    {% endif %}

  </div>
</div>

{% if auto_open_unit_modal %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var el = document.getElementById("createUnitModal");
    if (!el || !window.bootstrap) return;

    var modal = window.bootstrap.Modal.getOrCreateInstance(el);
    modal.show();
  });
</script>
{% endif %}

{% endblock %}
