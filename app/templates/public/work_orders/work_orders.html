{% extends "layouts/app_base.html" %}

{% block page_title %}Work Orders{% endblock %}

{% block app_content %}
<div class="card">
  <div class="card-body d-flex align-items-start justify-content-between gap-3">
    <div>
      <h1 class="h4 mb-2">Management</h1>
      <p class="text-muted mb-0">Work orders, payments, and estimates.</p>
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-primary" href="{{ url_for('work_orders.work_order_details_page') }}">
        + Create Work Order
      </a>
    </div>
  </div>
</div>

<!-- Navigation Tabs -->
<div class="card mt-3">
  <div class="card-body">
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-work-orders" data-bs-toggle="tab" data-bs-target="#content-work-orders" type="button" role="tab" aria-controls="content-work-orders" aria-selected="true">
          Work Orders
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-payments" data-bs-toggle="tab" data-bs-target="#content-payments" type="button" role="tab" aria-controls="content-payments" aria-selected="false">
          Payments
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-estimates" data-bs-toggle="tab" data-bs-target="#content-estimates" type="button" role="tab" aria-controls="content-estimates" aria-selected="false">
          Estimates
        </button>
      </li>
    </ul>
  </div>
</div>

<!-- Tab Content -->
<div class="tab-content mt-3">
  <!-- Work Orders Tab -->
  <div class="tab-pane fade show active" id="content-work-orders" role="tabpanel" aria-labelledby="tab-work-orders">
    <div class="card">
      <div class="card-body">
        {% if work_orders and work_orders|length > 0 %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Customer</th>
                  <th>Date</th>
                  <th>Unit</th>
                  <th class="text-end">Labor</th>
                  <th class="text-end">Parts</th>
                  <th class="text-end">Total</th>
                  <th class="text-center">Paid</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for w in work_orders %}
                  <tr>
                    <td>{{ w.customer }}</td>
                    <td>{{ w.date }}</td>
                    <td>{{ w.unit }}</td>
                    <td class="text-end">${{ "%.2f"|format(w.labor_total) }}</td>
                    <td class="text-end">${{ "%.2f"|format(w.parts_total) }}</td>
                    <td class="text-end fw-semibold">${{ "%.2f"|format(w.grand_total) }}</td>
                    <td class="text-center">
                      {% if w.is_paid %}
                        <span class="badge bg-success">Paid</span>
                      {% else %}
                        <button
                          type="button"
                          class="badge bg-warning text-dark border-0 js-mark-paid"
                          data-work-order-id="{{ w.id }}"
                          title="Click to mark as paid"
                          style="cursor:pointer;"
                        >
                          Unpaid
                        </button>
                      {% endif %}
                    </td>
                    <td class="text-end">
                      <a class="btn btn-outline-primary btn-sm" href="{{ url_for('work_orders.work_order_details_page', work_order_id=w.id) }}">
                        Edit
                      </a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-muted">No work orders yet.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Payments Tab -->
  <div class="tab-pane fade" id="content-payments" role="tabpanel" aria-labelledby="tab-payments">
    <div class="card">
      <div class="card-body">
        <div id="payments-loading" class="text-muted d-none">
          <div class="spinner-border spinner-border-sm me-2" role="status" style="width: 1rem; height: 1rem;"></div>
          Loading payments...
        </div>
        <div id="payments-content" class="d-none"></div>
        <div id="payments-empty" class="text-muted">No payments recorded yet.</div>
      </div>
    </div>
  </div>

  <!-- Estimates Tab -->
  <div class="tab-pane fade" id="content-estimates" role="tabpanel" aria-labelledby="tab-estimates">
    <div class="card">
      <div class="card-body">
        <div class="text-muted">Estimates feature coming soon.</div>
      </div>
    </div>
  </div>
</div>

<!-- Payment Modal for Work Orders List -->
<div class="modal fade" id="paymentModalList" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Record Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="alert alert-info mb-3">
          <div class="small">Invoice Total: <strong id="paymentListInvoiceTotal">—</strong></div>
          <div class="small">Already Paid: <strong id="paymentListAlreadyPaid">—</strong></div>
          <div class="small">Remaining Balance: <strong id="paymentListRemainingBalance">—</strong></div>
        </div>

        <div class="mb-3">
          <label class="form-label">Payment Amount</label>
          <input type="number" id="paymentListAmountInput" class="form-control" inputmode="decimal" placeholder="0.00" step="0.01" min="0">
          <small class="text-muted" id="paymentListAmountHelp"></small>
        </div>

        <div class="mb-3">
          <label class="form-label">Payment Method</label>
          <select id="paymentListMethodInput" class="form-select">
            <option value="cash">Cash</option>
            <option value="check">Check</option>
            <option value="credit_card">Credit Card</option>
            <option value="ach">ACH</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Notes (optional)</label>
          <textarea id="paymentListNotesInput" class="form-control" rows="2" placeholder="e.g., Check #12345, etc."></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="paymentListSubmitBtn" class="btn btn-primary">Record Payment</button>
      </div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/work_orders/work_orders.js', v='20260224b') }}"></script>
{% endblock %}