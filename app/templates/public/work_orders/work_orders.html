{% extends "layouts/app_base.html" %}

{% block page_title %}Work Orders{% endblock %}

{% block app_content %}
<div class="card">
  <div class="card-body d-flex align-items-start justify-content-between gap-3">
    <div>
      <h1 class="h4 mb-2">Work Orders</h1>
      <p class="text-muted mb-0">Manage your work orders.</p>
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-primary" href="{{ url_for('work_orders.work_order_details_page') }}">
        + Create Work Order
      </a>
    </div>
  </div>
</div>

<div class="card mt-3">
  <div class="card-body">
    {% if work_orders and work_orders|length > 0 %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Customer</th>
              <th>Date</th>
              <th>Unit</th>
              <th class="text-end">Labor</th>
              <th class="text-end">Parts</th>
              <th class="text-end">Total</th>
              <th class="text-center">Paid</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for w in work_orders %}
              <tr>
                <td>{{ w.customer }}</td>
                <td>{{ w.date }}</td>
                <td>{{ w.unit }}</td>
                <td class="text-end">${{ "%.2f"|format(w.labor_total) }}</td>
                <td class="text-end">${{ "%.2f"|format(w.parts_total) }}</td>
                <td class="text-end fw-semibold">${{ "%.2f"|format(w.grand_total) }}</td>
                <td class="text-center">
                  {% if w.is_paid %}
                    <span class="badge bg-success">Paid</span>
                  {% else %}
                    <button
                      type="button"
                      class="badge bg-warning text-dark border-0 js-mark-paid"
                      data-work-order-id="{{ w.id }}"
                      title="Click to mark as paid"
                      style="cursor:pointer;"
                    >
                      Unpaid
                    </button>
                  {% endif %}
                </td>
                <td class="text-end">
                  <a class="btn btn-outline-primary btn-sm" href="{{ url_for('work_orders.work_order_details_page', work_order_id=w.id) }}">
                    Edit
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">No work orders yet.</div>
    {% endif %}
  </div>
</div>

<!-- Payment Modal for Work Orders List -->
<div class="modal fade" id="paymentModalList" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Record Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="alert alert-info mb-3">
          <div class="small">Invoice Total: <strong id="paymentListInvoiceTotal">—</strong></div>
          <div class="small">Already Paid: <strong id="paymentListAlreadyPaid">—</strong></div>
          <div class="small">Remaining Balance: <strong id="paymentListRemainingBalance">—</strong></div>
        </div>

        <div class="mb-3">
          <label class="form-label">Payment Amount</label>
          <input type="number" id="paymentListAmountInput" class="form-control" inputmode="decimal" placeholder="0.00" step="0.01" min="0">
          <small class="text-muted" id="paymentListAmountHelp"></small>
        </div>

        <div class="mb-3">
          <label class="form-label">Payment Method</label>
          <select id="paymentListMethodInput" class="form-select">
            <option value="cash">Cash</option>
            <option value="check">Check</option>
            <option value="credit_card">Credit Card</option>
            <option value="ach">ACH</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Notes (optional)</label>
          <textarea id="paymentListNotesInput" class="form-control" rows="2" placeholder="e.g., Check #12345, etc."></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="paymentListSubmitBtn" class="btn btn-primary">Record Payment</button>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    "use strict";

    async function postJson(url, body) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Accept": "application/json" },
        body: JSON.stringify(body || {}),
      });

      let data = null;
      try { data = await res.json(); } catch { data = null; }

      if (!res.ok || !data || data.ok !== true) {
        const msg = (data && (data.error || data.message)) ? (data.error || data.message) : "Failed to update.";
        throw new Error(msg);
      }

      return data;
    }

    async function getJson(url) {
      const res = await fetch(url, {
        method: "GET",
        headers: { "Accept": "application/json" },
      });

      let data = null;
      try { data = await res.json(); } catch { data = null; }

      if (!res.ok || !data || data.ok !== true) {
        const msg = (data && (data.error || data.message)) ? (data.error || data.message) : "Failed to fetch.";
        throw new Error(msg);
      }

      return data;
    }

    let currentWorkOrderId = null;

    document.addEventListener("click", async function (e) {
      const btn = e.target.closest(".js-mark-paid");
      if (!btn) return;

      const workOrderId = String(btn.dataset.workOrderId || "").trim();
      if (!workOrderId) return;

      currentWorkOrderId = workOrderId;

      // Fetch payment info
      try {
        const data = await getJson(`/work_orders/api/work_orders/${encodeURIComponent(workOrderId)}/payments`);
        
        // Update modal with balance info
        document.getElementById("paymentListInvoiceTotal").textContent = `$${(data.grand_total || 0).toFixed(2)}`;
        document.getElementById("paymentListAlreadyPaid").textContent = `$${(data.paid_amount || 0).toFixed(2)}`;
        document.getElementById("paymentListRemainingBalance").textContent = `$${(data.remaining_balance || 0).toFixed(2)}`;
        
        // Pre-fill amount with remaining balance
        const remainingBalance = data.remaining_balance || 0;
        document.getElementById("paymentListAmountInput").value = remainingBalance > 0 ? remainingBalance.toFixed(2) : "";
        document.getElementById("paymentListMethodInput").value = "cash";
        document.getElementById("paymentListNotesInput").value = "";

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById("paymentModalList"));
        modal.show();
      } catch (err) {
        alert(err.message || "Failed to load payment info.");
      }
    });

    document.getElementById("paymentListSubmitBtn")?.addEventListener("click", async function () {
      if (!currentWorkOrderId) return;

      const amount = parseFloat(document.getElementById("paymentListAmountInput").value || "0");
      const paymentMethod = document.getElementById("paymentListMethodInput").value;
      const notes = document.getElementById("paymentListNotesInput").value;

      if (amount <= 0) {
        alert("Please enter a valid payment amount.");
        return;
      }

      const btn = this;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = "Saving...";

      try {
        const data = await postJson(`/work_orders/api/work_orders/${encodeURIComponent(currentWorkOrderId)}/payment`, {
          amount,
          payment_method: paymentMethod,
          notes
        });

        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById("paymentModalList"));
        modal.hide();

        // Update UI
        if (data.is_fully_paid) {
          const row = document.querySelector(`button[data-work-order-id="${currentWorkOrderId}"]`)?.closest("tr");
          if (row) {
            const td = row.querySelector("td:nth-child(7)");
            if (td) {
              td.innerHTML = '<span class="badge bg-success">Paid</span>';
            }
          }
        }

        alert("Payment recorded successfully!");
        currentWorkOrderId = null;
      } catch (err) {
        alert(err.message || "Failed to record payment.");
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    });
  })();
</script>
{% endblock %}